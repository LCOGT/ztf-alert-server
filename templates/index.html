{% extends 'base.html' %}
{% block content %}
<div class="row">
  <div class="col-md-12">
    <p>
      The following table lists ZTF alerts in descending order by JD. Use the filters on the right to narrow down
      the results to interesting candidates. When the results look good, add <code>?format=json</code> to the url. You can
      now access this url to retrieve the full data and use it in your scripts.
      You can access an alert's previous alerts by visiting <code>/&lt;id&gt;/</code> where id is the value
      of the lco_id key in the json view or by clicking the id link in the table.
    </p>
    <p>
      <a href="#" onClick="toggleDescriptions()"><strong>Column Descriptions</strong></a>
      <span class="col-descriptions">▶</span>
      <span class="col-descriptions d-none">▼</span>
    </p>
    <ul class="list-unstyled d-none col-descriptions">
      <li><strong>lco_id</strong>: Unique ID for this alert, assigned by LCO.</li>
      <li><strong>objectId</strong>: Unique identifier for this object.</li>
      <li><strong>jd</strong>: Observation Julian date at start of exposure [days]</li>
      <li><strong>filter</strong>: (derived) Filter name (g, r, i) derived from <strong>fid</strong> (1, 2, 3).</li>
      <li><strong>ra</strong>: Right Ascension of candidate; J2000 [deg]</li>
      <li><strong>dec</strong>: Declination of candidate; J2000 [deg]</li>
      <li><strong>magpsf</strong>: Magnitude from PSF-fit photometry measured from difference image [mag]</li>
      <li><strong>magpap</strong>: Aperture mag using 8 pixel diameter aperture measured from difference image [mag]</li>
      <li><strong>distnr</strong>: Distance to nearest source in reference image PSF-catalog within 30 arcsec (1 pixel = 1.0 arcsecond) [pixels]</li>
      <li><strong>deltamaglatest</strong>: (Derived) magpsf[this alert] - magpsf[last alert at this location from image of same filter] if a previous alert is available, otherwise Null.</li>
      <li><strong>deltamagref</strong>: (Derived) If distnr &lt; 2” (~2 ZTF pixels), deltamagref = (magnr - magpsf), otherwise Null.</li>
      <li><strong>rb</strong>: RealBogus quality score; range is 0 to 1 where closer to 1 is more reliable.</li>
      <li><strong>classtar</strong>: Star/Galaxy classification score from SExtractor measured from the difference image.</li>
    </ul>
  </div>
</div>
<div class="row">
  <div class="col-md-2">
    <form method="GET" action="/">
      <button type="submit" class="btn btn-primary">Select</button>
      <a href="/" class="btn btn-secondary">Reset</a>
      <div class="form-group">
        <label for="objectId">objectId</label>
        <input type="text" class="form-control form-control-sm" id="objectId" name="objectId" value="{{ request.args.objectId }}">
      </div>
      <div class="form-group">
        <label for="candid">candid</label>
        <input type="text" class="form-control form-control-sm" id="candid" name="candid" value="{{ request.args.candid }}">
      </div>

      <label for="jd__gt">jd</label>
      <div class="form-row">
        <div class="col">
          <input type="number" step="any" class="form-control form-control-sm" id="jd__gt" name="jd__gt" value="{{ request.args.jd__gt }}" placeholder="Lower">
        </div>
        <div class="col">
           <input type="number" step="any" class="form-control form-control-sm" id="jd__lt" name="jd__lt" value="{{ request.args.jd__lt }}" placeholder="Upper">
        </div>
      </div>

      <div class="form-group">
        <label for="filter">Filter</label>
        <select id="filter" name="filter" class="form-control form-control-sm" value="{{ request.args.filter }}">
          <option value="" {% if request.args.filter == '' %} selected {% endif %}></option>
          <option value="g" {% if request.args.filter == 'g' %} selected {% endif %}>g</option>
          <option value="r" {% if request.args.filter == 'r' %} selected {% endif %}>r</option>
          <option value="i" {% if request.args.filter == 'i' %} selected {% endif %}>i</option>
        </select>
      </div>

      <div class="form-group">
        <label for="cone">Cone Search</label>
        <input type="text" class="form-control form-control-sm" id="cone" name="cone" value="{{ request.args.cone }}">
        <small class="form-text text-muted">Format: ra,dec,radius in degrees.</small>
      </div>
      <div class="form-group">
        <label for="objectidps">Nearby Objects</label>
        <input type="text" class="form-control form-control-sm" id="objectidps" name="objectidps" value="{{ request.args.objectidps }}">
        <small class="form-text text-muted">ID from PS1 catalog.</small>
      </div>


      <!-- Equatorial coords -->
      <div id="equatorial_coords">
        <p>Equatorial Coords</p>
        <label for="ra__gt">ra</label>
        <div class="form-row">
          <div class="col">
            <input type="number" step="any" class="form-control form-control-sm" id="ra__gt" name="ra__gt" value="{{ request.args.ra__gt }}" placeholder="Lower">
          </div>
          <div class="col">
             <input type="number" step="any" class="form-control form-control-sm" id="ra__lt" name="ra__lt" value="{{ request.args.ra__lt }}" placeholder="Upper">
          </div>
        </div>

        <label for="dec__gt">dec</label>
        <div class="form-row">
          <div class="col">
            <input type="number" step="any" class="form-control form-control-sm" id="dec__gt" name="dec__gt" value="{{ request.args.dec__gt }}" placeholder="Lower">
          </div>
          <div class="col">
             <input type="number" step="any" class="form-control form-control-sm" id="dec__lt" name="dec__lt" value="{{ request.args.dec__lt }}" placeholder="Upper">
          </div>
        </div>
      </div>

      <!-- galactic coords -->
      <div id="galactic_coords">
        <p>Galactic Coords</p>
        <label for="l__gt">l</label>
        <div class="form-row">
          <div class="col">
            <input type="number" step="any" class="form-control form-control-sm" id="l__gt" name="l__gt" value="{{ request.args.l__gt }}" placeholder="Lower">
          </div>
          <div class="col">
             <input type="number" step="any" class="form-control form-control-sm" id="l__lt" name="l__lt" value="{{ request.args.l__lt }}" placeholder="Upper">
          </div>
        </div>

        <label for="b__gt">b</label>
        <div class="form-row">
          <div class="col">
            <input type="number" step="any" class="form-control form-control-sm" id="b__gt" name="b__gt" value="{{ request.args.b__gt }}" placeholder="Lower">
          </div>
          <div class="col">
             <input type="number" step="any" class="form-control form-control-sm" id="b__lt" name="b__lt" value="{{ request.args.b__lt }}" placeholder="Upper">
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="magpsf__lte">magpsf &lt;=</label>
        <input type="number" step="any" class="form-control form-control-sm" id="magpsf__lte" name="magpsf__lte" value="{{ request.args.magpsf__lte }}">
      </div>
      <div class="form-group">
        <label for="sigmapsf__lte">sigmapsf &lt;= </label>
        <input type="number" step="any" class="form-control form-control-sm" id="sigmapsf__lte" name="sigmapsf__lte" value="{{ request.args.sigmapsf__lte }}">
      </div>
      <div class="form-group">
        <label for="magap__lte">magap &lt;=</label>
        <input type="number" step="any" class="form-control form-control-sm" id="magap__lte" name="magap__lte" value="{{ request.args.magap__lte }}">
      </div>
      <div class="form-group">
        <label for="distnr__lte">distnr &lt;=</label>
        <input type="number" step="any" class="form-control form-control-sm" id="distnr__lte" name="distnr__lte" value="{{ request.args.distnr__lte }}">
      </div>
      <div class="form-group">
        <label for="deltamaglatest__gte">Delta Mag &gt;= </label>
        <input type="number" step="any" class="form-control form-control-sm" id="deltamaglatest__gte" name="deltamaglatest__gte" value="{{ request.args.deltamaglatest__gte }}">
        <small class="form-text text-muted">Absolute Value</small>
      </div>
      <div class="form-group">
        <label for="deltamagref__gte">Delta Mag Ref &gt;= </label>
        <input type="number" step="any" class="form-control form-control-sm" id="deltamagref__gte" name="deltamagref__gte" value="{{ request.args.deltamagref__gte }}">
        <small class="form-text text-muted">Absolute Value</small>
      </div>
      <div class="form-group">
        <label for="rb__gte">rb &gt;= </label>
        <input type="number" step="any" class="form-control form-control-sm" id="rb__gte" name="rb__gte" value="{{ request.args.rb__gte }}">
      </div>
      <label for="classtar__gt">classtar</label>
      <div class="form-row">
        <div class="col">
          <input type="number" step="any" class="form-control form-control-sm" id="classtar__gte" name="classtar__gte" value="{{ request.args.classtar__gte }}" placeholder="Lower">
        </div>
        <div class="col">
           <input type="number" step="any" class="form-control form-control-sm" id="classtar__lte" name="classtar__lte" value="{{ request.args.classtar__lte }}" placeholder="Upper">
        </div>
      </div>
      <div class="form-group">
        <label for="fwhm__lte">fwhm &lt;= </label>
        <input type="number" step="any" class="form-control form-control-sm" id="fwhm__lte" name="fwhm__lte" value="{{ request.args.fwhm__lte }}">
      </div>
      <button type="submit" class="btn btn-primary">Select</button>
      <a href="/" class="btn btn-secondary">Reset</a>
    </form>
  </div>
  <div class="col-md-10">
    <div class="table-responsive">
    {% if context.has_prev %}
    <a href="/?{{ arg_str }}&page={{ page - 1 }}" class="btn btn-primary">Prev</a>
    {% else %}
    <a href="#" class="btn btn-primary disabled">Prev</a>
    {% endif %}
    {% if context.has_next %}
    <a href="/?{{ arg_str }}&page={{ page + 1 }}" class="btn btn-primary">Next</a>
    {% else %}
    <a href="#" class="btn btn-primary disabled">Next</a>
    {% endif %}
    Results: {{ context.total }} Pages: {{ context.pages }}
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th>id</th>
          <th>objectId</th>
          <th>jd</th>
          <th>filter</th>
          <th title="degrees">ra</th>
          <th title="degrees">dec</th>
          <th title="magnitude">magpsf</th>
          <th title="magap">magap</th>
          <th title="distnr">distnr</th>
          <th title="Diff in magnitude from previous alert">Δmaglatest</th>
          <th title="">Δmagref</th>
          <th title="Real/Bogus score">rb</th>
        </tr>
      </thead>
      <tbody>
        {% for alert in context.results %}
        <tr>
          <td><a href="/{{ alert.lco_id }}/" title="{{ alert.lco_id }}">{{ alert.lco_id }}</a></td>
          <td>{{ alert.objectId }}</td>
          <td>{{ alert.candidate.jd }}</td>
          <td>{{ alert.candidate.filter }}</td>
          <td>{{ '%.3f'|format(alert.candidate.ra) }}</td>
          <td>{{ '%.3f'|format(alert.candidate.dec) }}</td>
          <td>{{ '%.2f'|format(alert.candidate.magpsf) }}</td>
          <td>{{ '%.2f'|format(alert.candidate.magap) }}</td>
          <td>{{ '%.3f'|format(alert.candidate.distnr) }}</td>
          <td>{{ '%.2f'|format(alert.candidate.deltamaglatest) if alert.candidate.deltamaglatest }}</td>
          <td>{{ '%.2f'|format(alert.candidate.deltamagref) if alert.candidate.deltamagref }}</td>
          <td>{{ '%.3f'|format(alert.candidate.rb) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
  </div>
</div>
  <script type="text/javascript">
    function toggleDescriptions(){
      colDescriptions = document.getElementsByClassName('col-descriptions');
      for(var i = 0; i < colDescriptions.length; i++){
        colDescriptions[i].classList.toggle('d-none');
      }
    }
  </script>
{% endblock %}
